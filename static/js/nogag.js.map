{"version":3,"sources":["nogag.js"],"names":["webfontReady","font","opts","Promise","resolve","reject","canvas","document","createElement","ctx","getContext","TEST_TEXT","TEST_SIZE","timeout","Date","now","me","w1","measureText","width","w2","w3","console","log","setTimeout","Nogag","data","key","documentElement","getAttribute","initImages","it","photos","querySelectorAll","placeholders","i","anchor","img","querySelector","src","setAttribute","href","height","wRatio","window","innerWidth","hRatio","innerHeight","ratio","Math","max","round","fillStyle","fillRect","toDataURL","replace","link","classList","add","loader","Image","onload","remove","init","articles","initEntry","DateRelative","updateAll","similar","getElementById","req","XMLHttpRequest","open","e","JSON","parse","responseText","ids","match","val","result","ad","article","container","innerHTML","trackbacks","links","getElementsByTagName","j","duplicate","parentNode","removeChild","length","onerror","send","exif","hasOwnProperty","model","target","info","make","focallength","fnumber","iso","speed","title","button","addEventListener","location","then","balance","join","entry","loadScript","url","script","body","appendChild","via","indexOf"],"mappings":"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","file":"../../../../../../tmp/d20170511-25445-kh6rvi/nogag.js20170511-25445-1nnpnfe","sourcesContent":["function webfontReady (font, opts) {\n\tif (!opts) opts = {};\n\treturn new Promise(function (resolve, reject) {\n\t\tvar canvas = document.createElement('canvas');\n\t\tvar ctx = canvas.getContext('2d');\n\t\tvar TEST_TEXT = \"test.@01N日本語\";\n\t\tvar TEST_SIZE = \"100px\";\n\n\t\tvar timeout = Date.now() + (opts.timeout || 3000);\n\t\t(function me () {\n\t\t\tctx.font = TEST_SIZE + \" '\" + font + \"', sans-serif\";\n\t\t\tvar w1 = ctx.measureText(TEST_TEXT).width;\n\t\t\tctx.font = TEST_SIZE + \" '\" + font + \"', serif\";\n\t\t\tvar w2 = ctx.measureText(TEST_TEXT).width;\n\t\t\tctx.font = TEST_SIZE + \" '\" + font + \"', monospace\";\n\t\t\tvar w3 = ctx.measureText(TEST_TEXT).width;\n\t\t\tconsole.log(w1, w2, w3);\n\t\t\tif (w1 === w2 && w1 === w3) {\n\t\t\t\tresolve();\n\t\t\t} else {\n\t\t\t\tif (Date.now() < timeout) {\n\t\t\t\t\tsetTimeout(me, 100);\n\t\t\t\t} else {\n\t\t\t\t\treject('timeout');\n\t\t\t\t}\n\t\t\t}\n\t\t})();\n\t});\n}\n\nNogag = {\n\tdata : function (key) {\n\t\treturn document.documentElement.getAttribute('data-' + key);\n\t},\n\n\tinitImages : function () {\n\t\tvar canvas = document.createElement('canvas');\n\t\tvar ctx = canvas.getContext('2d');\n\n\t\tvar photos = document.querySelectorAll('a.picasa');\n\t\tvar placeholders = {};\n\t\tfor (var i = 0, it; (it = photos[i]); i++) (function (anchor) {\n\t\t\tvar img = anchor.querySelector('img');\n\t\t\tvar src = img.getAttribute('src');\n\t\t\tanchor.setAttribute('data-href', anchor.href);\n\n\t\t\t// Loading placeholder\n\t\t\tvar width = img.getAttribute('width');\n\t\t\tvar height = img.getAttribute('height');\n\t\t\tvar wRatio = width  / window.innerWidth;\n\t\t\tvar hRatio = height / window.innerHeight;\n\t\t\tvar ratio = Math.max(wRatio, hRatio);\n\t\t\tif (ratio > 1) {\n\t\t\t\twidth  = Math.round(width  / ratio);\n\t\t\t\theight = Math.round(height / ratio);\n\t\t\t}\n\t\t\tconsole.log('fill empty image', width, height, wRatio, hRatio);\n\t\t\tif (width && height) {\n\t\t\t\tif (!placeholders[ width + 'x' + height ]) {\n\t\t\t\t\tcanvas.width = width;\n\t\t\t\t\tcanvas.height = height;\n\t\t\t\t\tctx.fillStyle = \"#dddddd\";\n\t\t\t\t\tctx.fillRect(0, 0, width, height);\n\t\t\t\t\tplaceholders[ width + 'x' + height ] = canvas.toDataURL('image/png');\n\t\t\t\t}\n\t\t\t\timg.src = placeholders[ width + 'x' + height ];\n\t\t\t}\n\n\t\t\tif (window.innerWidth > 1650) {\n\t\t\t\t// use fullsize\n\t\t\t\tsrc = src.replace(/\\/s\\d+\\//, '/s0/');\n\t\t\t}\n\n\t\t\tvar link = src.replace(/\\/s(9[06]0|1280|2048)\\//, '/s0/');\n\n\t\t\tanchor.href = link;\n\n\t\t\tif (src !== img.getAttribute('src')) {\n\t\t\t\tanchor.classList.add(\"loading\");\n\t\t\t\tvar loader = new Image();\n\t\t\t\tconsole.log('upgrade loading ' + src);\n\t\t\t\tloader.onload = function () {\n\t\t\t\t\timg.src = src;\n\t\t\t\t\tconsole.log('upgraded');\n\t\t\t\t\tanchor.classList.remove('loading')\n\t\t\t\t};\n\t\t\t\tloader.src = src;\n\t\t\t}\n\t\t})(it);\n\n\t},\n\n\tinit : function () {\n\t\tvar articles = document.querySelectorAll('article');\n\t\tfor (var i = 0, it; (it = articles[i]); i++) {\n\t\t\tNogag.initEntry(it);\n\t\t}\n\n\t\tDateRelative.updateAll();\n\n//\t\tvar timer = null, current = null;\n//\t\t$(window).scroll(function () {\n//\t\t\tclearTimeout(timer);\n//\t\t\ttimer = setTimeout(function () {\n//\t\t\t\tvar sections = $('article > header').map(function () {\n//\t\t\t\t\tvar $this = $(this);\n//\t\t\t\t\tvar article = $this.parent();\n//\t\t\t\t\treturn {\n//\t\t\t\t\t\telement : article,\n//\t\t\t\t\t\tstart : $this.offset().top,\n//\t\t\t\t\t\tend   : $this.offset().top + article.height()\n//\t\t\t\t\t};\n//\t\t\t\t});\n//\n//\t\t\t\tvar scrollTop = $(window).scrollTop();\n//\t\t\t\tvar section = null;\n//\t\t\t\tfor (var i = 0, it; (it = sections[i]); i++) {\n//\t\t\t\t\tif (it.start < scrollTop && scrollTop < it.end) {\n//\t\t\t\t\t\tsection = it;\n//\t\t\t\t\t\tbreak;\n//\t\t\t\t\t}\n//\t\t\t\t}\n//\n//\t\t\t\tif (current !== section) {\n//\t\t\t\t\tif (current) current.element.removeClass('current');\n//\t\t\t\t\tif (section) section.element.addClass('current');\n//\t\t\t\t\tcurrent = section;\n//\t\t\t\t}\n//\t\t\t}, 10);\n//\t\t}).scroll();\n\n\t\t(function () {\n\t\t\tvar similar = document.getElementById('preload-similar-entries').href;\n\t\t\tvar req = new XMLHttpRequest();\n\t\t\treq.open(\"GET\", similar);\n\t\t\treq.onload = function (e) {\n\t\t\t\tvar data = JSON.parse(req.responseText);\n\t\t\t\tvar ids = similar.match(/id=(\\d+)/g);\n\t\t\t\tfor (var i = 0, it; (it = ids[i]); i++) {\n\t\t\t\t\tvar key = it.replace(/^id=/, '')\n\t\t\t\t\tvar val = data.result[key] || '';\n\t\t\t\t\tif (data.ad)  {\n\t\t\t\t\t\tval += data.ad;\n\t\t\t\t\t\tdata.ad = \"\"; // display once\n\t\t\t\t\t}\n\t\t\t\t\tif (!val) continue;\n\n\t\t\t\t\tvar article = document.querySelector('article[data-id=\"' + key + '\"]');\n\t\t\t\t\tvar container = article.querySelector('.similar-entries');\n\t\t\t\t\tcontainer.innerHTML = val;\n\n\t\t\t\t\tvar trackbacks = article.querySelector('.content.trackbacks');\n\t\t\t\t\tif (trackbacks) {\n\t\t\t\t\t\tvar links = trackbacks.getElementsByTagName('li');\n\t\t\t\t\t\tfor (var j = 0, link; (link = links[j]); j++) {\n\t\t\t\t\t\t\tvar duplicate = container.querySelector('li[data-id=\"' + link.getAttribute('data-id') + '\"]');\n\t\t\t\t\t\t\tif (duplicate) {\n\t\t\t\t\t\t\t\tduplicate.parentNode.removeChild(duplicate);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!container.getElementsByTagName('li').length) {\n\t\t\t\t\t\t\tcontainer.parentNode.removeChild(container);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tDateRelative.updateAll(container);\n\t\t\t\t}\n\t\t\t};\n\t\t\treq.onerror = function (e) {\n\t\t\t};\n\t\t\treq.send(null);\n\t\t})();\n\n\t\t(function () {\n\t\t\tvar exif = document.getElementById('preload-exif-entries').href;\n\t\t\tvar req = new XMLHttpRequest();\n\t\t\treq.open(\"GET\", exif);\n\t\t\treq.onload = function (e) {\n\t\t\t\tvar data = JSON.parse(req.responseText);\n\t\t\t\tfor (var key in data.result) if (data.result.hasOwnProperty(key)) {\n\t\t\t\t\tvar val = data.result[key];\n\t\t\t\t\tif (!val || !val.model) continue;\n\t\t\t\t\tvar target = document.querySelector('[data-href=\"' + key + '\"]');\n\t\t\t\t\tvar info =\n\t\t\t\t\t\tval.model + ' (' + val.make + ') ' +\n\t\t\t\t\t\tval.focallength + 'mm ' +\n\t\t\t\t\t\t'F' + val.fnumber + ' ' +\n\t\t\t\t\t\t'ISO' + val.iso + ' ' +\n\t\t\t\t\t\t(val.speed < 1 ? '1/' + Math.round(1/val.speed): val.speed ) + 'sec ';\n\t\t\t\t\ttarget.title = info;\n\t\t\t\t}\n\t\t\t};\n\t\t\treq.onerror = function (e) {\n\t\t\t};\n\t\t\treq.send(null);\n\n\t\t\tif (Nogag.data('auth')) {\n\t\t\t\tvar button = document.querySelector('.nogag-new');\n\t\t\t\tif (button) {\n\t\t\t\t\tbutton.addEventListener('click', function () {\n\t\t\t\t\t\tlocation.href = \"/edit\";\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t})();\n\n\t\twebfontReady(\"Sawarabi Mincho\").then(function () {\n\t\t\tbalance(document.querySelectorAll([\n\t\t\t\t'.entries article header h1 a',\n\t\t\t\t'.entries article header h2 a',\n\t\t\t\t'.entries article .content h1',\n\t\t\t\t'.entries article .content h2',\n\t\t\t\t'.entries article .content h3',\n\t\t\t\t'.entries article .content h4',\n\t\t\t\t'.entries article .content h5',\n\t\t\t\t'.entries article .content h6'\n\t\t\t].join(',')));\n\t\t});\n\t},\n\n\tinitEntry : function (entry) {\n\t\tif (Nogag.data('auth')) {\n\t\t\tvar button = entry.querySelector('.nogag-edit');\n\t\t\tif (button) {\n\t\t\t\tbutton.addEventListener('click', function () {\n\t\t\t\t\tlocation.href = \"/edit?id=\" + entry.getAttribute('data-id')\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t},\n\n\tloadScript : function (url) {\n\t\treturn new Promise( function (resolve, reject) {\n\t\t\tvar script = document.createElement('script');\n\t\t\tscript.onload = resolve;\n\t\t\tscript.onerror = reject;\n\t\t\tscript.src = url;\n\t\t\tdocument.body.appendChild(script);\n\t\t});\n\t}\n};\n\nNogag.initImages();\n\ndocument.addEventListener('DOMContentLoaded', function () {\n\tNogag.init();\n\n\tvar req = new XMLHttpRequest();\n\treq.open(\"GET\", '/.ip');\n\treq.onload = function (e) {\n\t\tvar via = req.responseText;\n\t\tif (via.indexOf('IPv') !== 0) return;\n\t\tdocument.getElementById('global-navigation').setAttribute('data-ip-info', 'via ' + via);\n\t};\n\treq.onerror = function (e) {\n\t};\n\treq.send(null);\n}, false);\n"]}