// TinySegmenter 0.1 -- Super compact Japanese tokenizer in Javascript
// (c) 2008 Taku Kudo <taku@chasen.org>
// TinySegmenter is freely distributable under the terms of a new BSD licence.
// For details, see http://chasen.org/~taku/software/TinySegmenter/LICENCE.txt

(function(global) {
    global.TinySegmenter = TinySegmenter;
    var default_model = {BC1:{IK:3047,MH:602,NA:680,NN:-1042},BC2:{AA:-9759,AH:589,AK:197,AO:545,HA:936,HH:-832,HN:2539,IA:3601,II:-732,IK:2438,IN:1527,KK:-13792,MH:-2977,NN:-439,OH:1097,OO:-1042},BC3:{AA:248,AN:3391,AO:582,HH:3695,HI:716,HK:-245,HO:-914,IA:-2463,IH:-2220,II:4051,IK:386,IO:-336,KK:1855,MH:909,NA:158,NI:633,NN:-129,OH:-2241,OI:-690,OO:1301},BIAS:-4809,BP1:{BB:629,BO:-353},BP2:{BO:1659,OB:-2196,OO:2778},BQ1:{BAN:1003,BHH:-737,BNN:-5567,BNO:1291,OHH:976,OII:258},BQ2:{BIH:-1330,BII:-504,BKI:720,OAA:-695,OAK:1409,OHA:84,OHH:-2899,OHI:-89,OHK:1045,OIH:64,OII:-200,OIO:-510,ONN:-4177,OOO:-2306,UHH:-924,UII:86},BQ3:{BOH:1971,OAN:2200,OHO:379,OII:59,OKO:-171,ONO:292},BQ4:{BAA:-577,BHH:-1243,BII:-1136,BKK:-1559,OAA:25,OAI:-186,OAO:-1012,OHI:-282,OIH:4724,OII:-1285,OIO:-3256,ONA:116,OOH:1494},BW1:{'_t':2377,'……':1270,'いい':646,'から':2559,'けど':767,'こと':-362,'しか':2133,'たら':3460,'たり':3111,'っと':1342,'てい':-2247,'でも':1091,'とか':1140,'どう':119,'ので':1348,'よう':-1981,'よく':614,'ると':763,'んな':1676,'場合':1510,'結構':915,ER:381,OS:3179,"T-":-140,al:978,ed:85,he:2283,le:340,on:210,or:296,to:672},BW2:{'、と':-854,'。な':-2258,'いか':492,'うざ':910,'がな':819,'きと':1148,'けど':-2835,'しま':-467,'った':-2377,'って':-302,'てあ':-3099,'てい':-2045,'てお':-2035,'てく':-228,'てみ':-837,'であ':-7449,'でき':-4333,'でし':-168,'です':-4238,'でも':-532,'とか':-1973,'ない':-4059,'にい':1026,'にし':4002,'にす':653,'にな':5507,'によ':-2270,'に対':-5590,'に関':-1788,'ので':-927,'の中':-55,'はな':-539,'もな':761,'らな':-1074,'りあ':-930,'りし':2839,'を通':-1675,ch:-1169,er:-2152},BW3:{'((':3656,'()':7621,'.s':1276,'あと':1744,'いい':4570,'いえ':2150,'いっ':612,'いて':-1127,'いろ':503,'うま':3302,'かか':2804,'かけ':2188,'かな':3761,'から':-1465,'こと':-7241,'この':6733,'これ':1509,'ころ':-4600,'しい':-2125,'しか':-1733,'した':736,'しな':2742,'しよ':1718,'すぐ':288,'する':563,'そう':-112,'その':5562,'たい':-482,'ただ':2021,'だい':3260,'だけ':-1947,'だっ':-4646,'だめ':1076,'ちょ':2037,'つけ':514,'てい':-432,'でき':5055,'でて':228,'とい':-4007,'とか':-5535,'とり':5027,'どう':4986,'なぁ':-3493,'なく':-27,'なし':2734,'なっ':2814,'なに':256,'なる':5020,'なん':-443,'にも':4571,'はて':1486,'ほう':-1409,'また':3473,'まだ':1649,'まと':1068,'みた':-1465,'もう':3509,'もっ':1521,'やつ':3260,'よう':-3675,'よく':4839,'わか':9708,'以下':-5672,'感じ':2397,'書い':113,'気が':-2532,20:-1082,45:-2144,of:1663,r2:1793,th:2075,to:171},TC1:{AAO:-265,AOA:1945,IIH:70,NAA:302,OHH:154},TC2:{AAA:-1285,IIH:77,IKI:355,KII:610,NAA:2518,NNN:-1351,NOA:1416,OHH:-992,OIK:475,OOI:519},TC3:{AAA:24,AAN:1483,AHH:698,ANN:-1056,HHI:737,HII:-113,IHH:144,IHI:-523,IIH:1262,III:-158,IIK:2449,IIO:-1228,IKK:1596,KII:445,KKI:-250,OAA:-175,OHI:1550,OII:1635,OIO:28,ONN:-139},TC4:{AAA:2737,AAI:-574,AOA:90,AON:29,HHI:493,HHK:308,HHO:-932,HIH:858,HII:32,HKK:-324,IAA:-266,IHH:-1163,IIH:467,III:1468,IIK:360,IKI:2193,IKK:-5158,IOO:148,KKK:3647,NNA:1141,NNN:-82,NON:467,OHH:-351,OII:-2061,OOI:157},TQ1:{BAAA:1792,BIII:-113,BONO:1278,OANN:3352,OHII:-481,OIIH:90,OIII:501,ONNN:-114},TQ2:{BAAA:-881,BANN:306,BHHI:-338,BHHK:-225,BHIH:-725,BIII:-1851,BKKK:-30,OAAA:1388,OAAN:-57,OHII:-36,OIHI:-1265,OIIH:498,OIII:-1795,OIIK:-278,OIIO:-296,OKKH:-173,OKKI:-464,OKKK:2293},TQ3:{BHIH:305,OAAA:584,OHHO:459,OIAA:-647,OIHI:-315,OIII:-172,OIMH:226,OKII:183,OKKK:508,OOAA:-626},TQ4:{BIAA:-935,BIII:-955,OAAA:-145,OAOA:1154,OHHH:129,OHHK:-429,OHIH:-781,OIII:202,OIIO:-1080,OKOK:-411},TW1:{'ぐらい':876,'なんか':2918,'なんて':1265,o45:1025,the:965},TW2:{'しかな':2163,'とりあ':-3899,ho4:-745},TW3:{'ていう':553,'ている':-6406,'てしま':-2249,'という':-2252,'ところ':-461,'として':-2542,'につい':-1135,'もそも':-402,'らない':-2450,'りする':1082},TW4:{'.co':5454,'.ne':824,'いない':113,'いろい':1984,'かった':-2349,'かなり':2818,'からだ':84,'ぐらい':-2063,'ちょっ':925,'ってか':254,'という':-2015,'とても':230,'とにか':1649,'なんて':-1240,'なんと':523,'みたい':-4080,ART:-3985,the:1791},UC1:{A:148,H:-455,I:-184,K:-183,N:366},UC2:{A:26},UC3:{A:2264,H:117,I:612,K:273,M:-1654,N:-3016,O:-352},UC4:{A:1871,H:-42,I:-9336,M:2916,N:2999,O:-13178},UC5:{H:73,I:-284,O:-810},UC6:{A:-156,H:-735,I:80,K:-334,N:398,O:-381},UP1:{},UP2:{B:390,O:-229},UP3:{O:473},UQ1:{BA:55,BH:117,BI:-69,BK:-214,OA:-60,OI:-197,ON:508},UQ2:{BH:-944,OA:-279,OH:370,OK:-271,OO:-359,UO:-64},UQ3:{BA:465,BH:1191,BI:1588,BM:-843,BN:-8358,OI:2018,OK:1075,OO:5200},UW1:{'(':-431,'、':-124,'。':101,'い':-30,'う':166,'こ':307,'し':-123,'す':122,'た':222,'っ':292,'で':-116,'に':-226,'よ':1574,'る':62,'を':-1061,'ア':-27,B1:760,R:-1102,S:-466,a:245,c:-806,i:572,o:783,t:75},UW2:{'(':-3727,'…':743,'、':-134,'。':-53,'「':-326,'い':-143,'う':163,'え':152,'か':303,'が':-333,'け':294,'し':47,'す':371,'そ':-1477,'た':335,'だ':325,'っ':325,'て':-837,'と':-28,'ど':255,'に':-270,'の':243,'ま':2373,'み':-1128,'も':-359,'り':-635,'る':-118,'を':-115,'ん':118,'ッ':465,'ー':681,'一':1245,'今':267,'何':364,'使':-201,'全':4416,'場':152,'安':85,'少':885,'必':634,'思':-610,'時':178,'書':-637,'最':2220,'直':28,'結':5023,'電':204,0:-224,4:78,B:-83,O:969,T:-850,e:93,n:436,o:207,t:-359},UW3:{'(':-12896,'-':-1622,'.':-2093,'/':545,'[':-8106,'…':559,'　':361,'、':6632,'。':6760,'「':-14026,'」':-1634,'【':-705,'ぁ':858,'い':-972,'う':2255,'か':2221,'が':10522,'き':-1236,'く':3369,'け':-168,'こ':-2171,'さ':-1758,'し':-1078,'す':-981,'ず':1252,'そ':-261,'だ':-911,'っ':-1712,'て':1789,'で':3238,'と':3088,'ど':2384,'な':-2201,'に':5211,'の':1381,'は':7350,'ば':947,'ま':-1474,'み':-1891,'も':5782,'よ':-726,'ら':1224,'り':-148,'る':-122,'れ':-1532,'わ':-1312,'を':9762,'ん':-28,'ッ':-2114,'ト':927,'ド':580,'ミ':171,'ル':1309,'ン':625,'ー':559,'今':3251,'他':1695,'以':-83,'全':1019,'再':1169,'分':1115,'前':645,'化':816,'失':1789,'度':2045,'日':815,'間':446,'際':409,'電':-681,'頭':1999,'（':-10261,0:-1063,H:-350,S:231,a:-1225,c:-908,d:952,e:29,f:573,i:-2306,k:993,m:747,o:-2523,p:-565,r:-228,s:962,t:31,u:-2928,y:2392},UW4:{'$':2346,'(':2473,'.':7081,'/':-804,'、':-7251,'。':-5147,'あ':7349,'い':1447,'う':-728,'ぇ':5227,'お':6448,'が':-5698,'き':-202,'け':-4936,'こ':4349,'ご':1320,'さ':557,'ざ':2633,'し':3307,'す':3440,'そ':6645,'た':-218,'だ':-804,'ち':3357,'ぢ':1530,'っ':-11022,'つ':2814,'て':-4324,'で':-1668,'と':-1913,'ど':2977,'な':1454,'に':-5517,'の':-5931,'は':-2025,'ひ':5818,'ふ':2357,'ほ':1385,'ま':1766,'む':2398,'め':117,'も':-587,'や':6079,'ら':-5984,'り':-2628,'る':-5927,'れ':-7070,'ろ':-729,'わ':756,'を':-9411,'ん':-7025,'ア':1067,'エ':264,'キ':671,'コ':407,'サ':590,'ス':341,'ッ':-2933,'ト':-968,'パ':1222,'ヘ':288,'ル':-1339,'ン':-6284,'・':1531,'ー':-3780,'中':-3192,'人':1585,'以':-9641,'何':1383,'使':1693,'度':-586,'後':-2473,'思':1262,'日':-1207,'時':-1277,'書':1553,'気':-1743,'用':-990,'的':-6639,'程':-4993,'良':-2542,'見':1794,'読':86,'込':-1015,'通':-210,'間':-1245,'限':-1695,0:335,A:287,B:1110,C:1452,D:911,G:311,I:1471,M:1544,N:709,P:2057,R:300,S:767,W:1187,X:1669,a:-1083,c:-116,d:-270,e:-3642,f:891,g:-964,i:-2125,l:-1839,m:-544,n:-1614,o:-3286,p:-367,r:-547,t:-2137,u:-1916,y:-1532},UW5:{'-':-1325,'.':951,'、':-499,'あ':-1275,'い':-80,'う':598,'え':2814,'が':-3306,'き':1610,'く':1818,'し':-1369,'じ':1668,'す':-2845,'ず':472,'そ':-183,'た':-118,'だ':-938,'っ':3777,'つ':2063,'て':316,'で':-5121,'と':-2146,'ど':-449,'な':-2673,'に':-3025,'の':-2839,'は':-3264,'ぶ':649,'め':1786,'も':-1162,'ゃ':637,'ょ':437,'ら':-247,'り':758,'る':2003,'れ':3414,'わ':1133,'を':-3139,'ん':2278,'イ':1081,'ケ':-198,'ッ':499,'ト':-692,'ャ':296,'ラ':306,'ー':1958,'下':-1080,'人':1140,'分':1162,'的':-2137,'ｒ':3220,2:121,a:1308,e:58,g:-369,h:896,i:542,m:-848,n:1630,o:699,t:-274},UW6:{')':-2111,'-':-1793,'/':-710,'い':-186,'う':-1849,'く':615,'け':-1147,'こ':-356,'さ':616,'し':501,'ず':-130,'そ':287,'た':-25,'っ':-264,'つ':116,'て':-732,'で':-313,'と':-58,'な':265,'の':-464,'も':152,'り':327,'る':-240,'れ':-816,'ん':563,'ン':-378,0:337,D:752,F:-290,H:-1008,O:-55,T:-59,b:86,c:399,e:-179,i:-331,p:634,s:189,t:241}};
    function TinySegmenter(model) {
        this.model = model || default_model;
    }

    var patterns = {
        "[一二三四五六七八九十百千万億兆]":"M",
        "[一-龠々〆ヵヶ]":"H",
        "[ぁ-ん]":"I",
        "[ァ-ヴーｱ-ﾝﾞｰ]":"K",
        "[a-zA-Zａ-ｚＡ-Ｚ]":"A",
        "[0-9０-９]":"N"
    };
    var chartype = [];
    for (var i in patterns) {
        var regexp = new RegExp;
        regexp.compile(i);
        chartype.push([regexp, patterns[i]]);
    }

    function getctype(str) {
        for (var i in chartype) {
            if (str.match(chartype[i][0])) {
                return chartype[i][1];
            }
        }
        return "O";
    }

    TinySegmenter.prototype.segment = function(input) {
        if (input == null || input == undefined || input == "") {
            return [];
        }
        var m = this.model;
        var result = [];
        var seg = ["B3","B2","B1"];
        var ctype = ["O","O","O"];
        var o = input.split("");
        for (i = 0; i < o.length; ++i) {
            seg.push(o[i]);
            ctype.push(getctype(o[i]));
        }
        seg.push("E1");
        seg.push("E2");
        seg.push("E3");
        ctype.push("O");
        ctype.push("O");
        ctype.push("O");
        var word = seg[3];
        var p1 = "U";
        var p2 = "U";
        var p3 = "U";
        for (var i = 4; i < seg.length - 3; ++i) {
            var score = m.BIAS;
            var w1 = seg[i-3];
            var w2 = seg[i-2];
            var w3 = seg[i-1];
            var w4 = seg[i];
            var w5 = seg[i+1];
            var w6 = seg[i+2];
            var c1 = ctype[i-3];
            var c2 = ctype[i-2];
            var c3 = ctype[i-1];
            var c4 = ctype[i];
            var c5 = ctype[i+1];
            var c6 = ctype[i+2];
            score += m.UP1[p1]||0;
            score += m.UP2[p2]||0;
            score += m.UP3[p3]||0;
            score += m.BP1[p1 + p2]||0;
            score += m.BP2[p2 + p3]||0;
            score += m.UW1[w1]||0;
            score += m.UW2[w2]||0;
            score += m.UW3[w3]||0;
            score += m.UW4[w4]||0;
            score += m.UW5[w5]||0;
            score += m.UW6[w6]||0;
            score += m.BW1[w2 + w3]||0;
            score += m.BW2[w3 + w4]||0;
            score += m.BW3[w4 + w5]||0;
            score += m.TW1[w1 + w2 + w3]||0;
            score += m.TW2[w2 + w3 + w4]||0;
            score += m.TW3[w3 + w4 + w5]||0;
            score += m.TW4[w4 + w5 + w6]||0;
            score += m.UC1[c1]||0;
            score += m.UC2[c2]||0;
            score += m.UC3[c3]||0;
            score += m.UC4[c4]||0;
            score += m.UC5[c5]||0;
            score += m.UC6[c6]||0;
            score += m.BC1[c2 + c3]||0;
            score += m.BC2[c3 + c4]||0;
            score += m.BC3[c4 + c5]||0;
            score += m.TC1[c1 + c2 + c3]||0;
            score += m.TC2[c2 + c3 + c4]||0;
            score += m.TC3[c3 + c4 + c5]||0;
            score += m.TC4[c4 + c5 + c6]||0;
            score += m.UQ1[p1 + c1]||0;
            score += m.UQ2[p2 + c2]||0;
            score += m.UQ3[p3 + c3]||0;
            score += m.BQ1[p2 + c2 + c3]||0;
            score += m.BQ2[p2 + c3 + c4]||0;
            score += m.BQ3[p3 + c2 + c3]||0;
            score += m.BQ4[p3 + c3 + c4]||0;
            score += m.TQ1[p2 + c1 + c2 + c3]||0;
            score += m.TQ2[p2 + c2 + c3 + c4]||0;
            score += m.TQ3[p3 + c1 + c2 + c3]||0;
            score += m.TQ4[p3 + c2 + c3 + c4]||0;
            var p = "O";
            if (score > 0) {
                result.push(word);
                word = "";
                p = "B";
            }
            p1 = p2;
            p2 = p3;
            p3 = p;
            word += seg[i];
        }
        result.push(word);
        return result;
    };
})(this);
